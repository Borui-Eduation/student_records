# AI助手本地测试指南

## 🚀 快速开始

### 方法1: 使用测试脚本（推荐）

```bash
# 1. 首先配置GEMINI_API_KEY（见下方"配置API密钥"部分）

# 2. 运行测试脚本
./test-ai-assistant.sh
```

### 方法2: 手动启动

```bash
# 1. 构建共享包
cd packages/shared && pnpm build && cd ../..

# 2. 启动开发服务器
pnpm dev

# 前端: http://localhost:3000
# 后端: http://localhost:8080
```

---

## 🔑 配置API密钥

### 获取Gemini API密钥

1. 访问 [Google AI Studio](https://makersuite.google.com/app/apikey)
2. 使用Google账号登录
3. 点击 **"Create API Key"** 或 **"Get API Key"**
4. 选择现有项目或创建新项目
5. 复制生成的API密钥（格式类似：`AIza...`）

### 配置到.env文件

编辑 `apps/api/.env`，添加：

```bash
# AI Services
GEMINI_API_KEY=AIzaSyC...你的实际密钥...
```

**注意**：
- 不要分享你的API密钥
- 不要提交.env文件到git
- Gemini API有免费额度（每天150万token）

---

## 🧪 测试场景

### 测试1: 创建新记录（基础功能）

**目标**：测试您的原始需求

**输入**：
```
帮我添加一个Hubery，今天10-12点，cello课程，rate 80
```

**预期结果**：
1. ✅ AI解析成功
2. ✅ 显示确认对话框：
   - 将创建客户: Hubery
   - 将创建课程类型: cello
   - 将创建费率: 80元/小时
   - 将创建session: 今天10:00-12:00
3. ✅ 点击"确认执行"后成功创建
4. ✅ 显示成功消息和影响的记录

**验证**：
- 在"Clients"页面应该看到新客户 Hubery
- 在"Session Types"页面应该看到 cello 课程类型
- 在"Rates"页面应该看到 80元/小时 的费率
- 在"Sessions"页面应该看到今天的课时记录

---

### 测试2: 查询数据

**输入**：
```
显示本月所有cello课程
```

**预期结果**：
- ✅ 返回本月所有cello课程的列表
- ✅ 包含客户名、日期、时间、金额等信息

---

### 测试3: 更新记录

**输入**：
```
更新Hubery的rate为90
```

**预期结果**：
1. ✅ 找到Hubery的费率记录
2. ✅ 显示确认对话框
3. ✅ 更新费率为90元/小时

**验证**：
- 在"Rates"页面确认费率已更新为90

---

### 测试4: 复杂查询

**输入**：
```
显示本周的所有课程
```

或

```
查询Hubery最近的3次课程
```

**预期结果**：
- ✅ 正确解析时间范围
- ✅ 返回符合条件的记录

---

### 测试5: 多客户场景

**输入**：
```
添加一个新客户Lisa，明天下午2-3点，piano课程，rate 100
```

**预期结果**：
- ✅ 创建新客户 Lisa
- ✅ 创建新课程类型 piano（如果不存在）
- ✅ 创建新费率 100元/小时
- ✅ 创建明天14:00-15:00的session

---

### 测试6: 删除操作

**输入**：
```
删除今天Hubery的课程
```

**预期结果**：
1. ✅ 显示警告确认对话框
2. ✅ 确认后删除记录

---

## 🎯 访问AI助手的三种方式

### 方式1: 浮动按钮（最快）
1. 登录到Dashboard: http://localhost:3000/dashboard
2. 点击右下角的 **✨ 浮动按钮**
3. 在弹出的对话框中输入指令

### 方式2: 侧边栏菜单
1. 登录到Dashboard
2. 点击左侧边栏的 **"AI Assistant"** 菜单项
3. 在专用页面中使用AI助手

### 方式3: 直接访问
- 访问：http://localhost:3000/dashboard/ai-assistant

---

## 🔍 调试和故障排除

### 查看后端日志

```bash
# 开发模式下，后端日志会直接显示在终端
# 查找类似这样的日志：
[ai-service] Parsing natural language input
[mcp-executor] Executing workflow
```

### 常见问题

#### 1. API密钥错误
```
错误: GEMINI_API_KEY is not configured
```

**解决**：
- 确认已在 `apps/api/.env` 中添加 GEMINI_API_KEY
- 重启开发服务器

#### 2. 解析失败
```
抱歉，我无法理解您的指令
```

**解决**：
- 使用更明确的语言
- 包含必要信息：客户名、时间、课程类型
- 参考测试场景中的示例

#### 3. 执行失败
```
操作失败：No applicable rate found
```

**解决**：
- 确保指定了rate金额
- 或先为客户创建rate

#### 4. 前端连接不上后端
```
Network Error
```

**解决**：
- 确认后端服务正在运行（http://localhost:8080/health）
- 检查 `apps/web/.env.local` 中的 `NEXT_PUBLIC_API_URL`

---

## 📊 性能测试

### 响应时间
- 第一次调用（冷启动）：2-5秒
- 后续调用：0.5-2秒

### API使用量
- 每次对话约消耗：1000-3000 tokens
- 免费额度：150万 tokens/天
- 足够支持：500-1500次对话/天

---

## 🎨 UI测试清单

### 对话界面
- [ ] 输入框可以输入中文
- [ ] Shift+Enter换行，Enter发送
- [ ] 消息显示时间戳
- [ ] 历史消息可滚动

### 确认对话框
- [ ] 清晰显示将要执行的操作
- [ ] "确认执行"和"取消"按钮正常工作
- [ ] 执行中显示loading状态

### 结果显示
- [ ] 成功消息显示绿色
- [ ] 错误消息显示红色
- [ ] 显示影响的记录数量

### 响应式设计
- [ ] 在手机屏幕上正常显示
- [ ] 对话框在小屏幕上可滚动
- [ ] 浮动按钮不遮挡内容

---

## 📝 测试记录模板

```markdown
## 测试记录 - [日期]

### 测试环境
- Node版本: 
- 浏览器: 
- Gemini模型: gemini-1.5-flash

### 测试结果

| 测试场景 | 输入 | 预期结果 | 实际结果 | 状态 |
|---------|------|---------|---------|------|
| 创建记录 | "帮我添加..." | 成功创建 | [填写] | ✅/❌ |
| 查询数据 | "显示本月..." | 返回列表 | [填写] | ✅/❌ |
| 更新记录 | "更新rate..." | 成功更新 | [填写] | ✅/❌ |

### 发现的问题
1. [问题描述]
2. [问题描述]

### 改进建议
1. [建议]
2. [建议]
```

---

## 🎯 高级测试场景

### 复杂时间解析
```
下周一早上9点到11点，给Lisa安排一个piano课
明天下午3点，Hubery的cello课，持续1.5小时
本周五10:30-12:00，添加一个新学生Tom
```

### 批量操作
```
为Hubery添加本周一到周五的cello课，每天下午2-3点
```

### 条件查询
```
查询本月收入超过1000元的客户
显示所有未开票的session
查找rate大于80的所有课程
```

---

## ✅ 测试完成检查清单

- [ ] GEMINI_API_KEY已配置
- [ ] 开发服务器正常启动
- [ ] 可以访问Dashboard
- [ ] AI助手浮动按钮可见且可点击
- [ ] 可以输入并发送消息
- [ ] AI能正确解析简单指令
- [ ] 确认对话框正常工作
- [ ] 能成功创建记录
- [ ] 能查询现有数据
- [ ] 能更新记录
- [ ] 错误处理友好
- [ ] 在不同浏览器测试通过
- [ ] 在移动设备上测试通过

---

## 📞 需要帮助？

如果遇到问题：
1. 检查浏览器控制台（F12）的错误信息
2. 检查后端终端的日志输出
3. 参考 `AI_ASSISTANT_SETUP.md` 的故障排除部分
4. 确认所有依赖已正确安装

---

**祝测试顺利！** 🎉

如果AI助手工作正常，您可以开始在实际工作中使用它来提高效率。

