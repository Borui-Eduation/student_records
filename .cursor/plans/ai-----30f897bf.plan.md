<!-- 30f897bf-fb4e-43fa-8cfc-19d2bf95b18a 5e4c2562-ea4f-44d6-84ef-1f13f488bd7d -->
# AI Assistant全功能自然语言CRUD系统

## 核心功能

### 1. 支持的实体（8种）

- Client（客户）
- Session（课时记录）
- SessionType（课程类型）
- Rate（费率）
- ClientType（客户类型）
- Invoice（发票）
- Expense（支出）
- ExpenseCategory（支出分类）

### 2. 支持的操作

- **Create**：创建新记录（已支持部分实体）
- **Read/Search**：查询记录（已支持基础查询，需增强）
- **Update**：更新记录（需完整实现）
- **Delete**：删除记录（需完整实现，含关联删除）
- **Merge**：合并重复记录（新功能）
- **Batch**：批量操作（新功能）

## 设计的自然语言命令示例

### 基础CRUD

```
创建：
- "添加一个新客户Jack，电话123456"
- "创建一个支出分类：办公用品"
- "为Tom生成本月发票"

查询：
- "查询所有未结算的session"
- "显示本周所有cello课程"
- "找出费率超过100的所有客户"
- "查看Tom的所有课时记录"
- "本月的总支出是多少"

更新：
- "把Hubery改名为Hubert"
- "更新Tom的电话为987654"
- "将所有cello课程的rate改为90"
- "标记ID为xxx的发票为已支付"

删除：
- "删除客户Sisey"
- "删除本月所有测试数据"
- "清除AI创建的所有记录"
```

### 关联操作

```
- "删除客户Tom，同时删除他的所有sessions和rates"
- "删除session时，如果是发票中的最后一个session，同时删除该发票"
- "更新客户名称，同时更新所有相关session中的clientName"
```

### 复杂查询组合

```
- "查询本月所有未结算的cello课程，按客户分组"
- "显示Tom和Jerry的所有课程，按日期排序"
- "找出所有rate超过80且本月有课的客户"
- "统计每个客户本月的总课时和金额"
- "查询AI创建的所有测试数据"
```

### 批量操作

```
- "将所有未结算的session标记为已结算"
- "删除所有空的clientType"
- "把所有今天的课程推迟一小时"
```

## 实现步骤

### Phase 1: 扩展AI Prompt系统

**文件**: `apps/api/src/services/aiService.ts`

增强`getSystemPrompt()`函数：

- 添加Invoice、Expense、ExpenseCategory的schema定义
- 添加Update和Delete操作的详细规则
- 添加关联删除的逻辑说明
- 添加复杂查询的解析规则
- 添加批量操作的支持
- 增加20+个新的示例覆盖所有操作类型

**关键规则**：

```typescript
// 关联删除规则
- 删除client时，询问是否同时删除其sessions、rates
- 删除session时，检查是否在invoice中，如果在已支付发票中则拒绝
- 删除sessionType时，检查是否有session使用，若有则拒绝或询问

// 批量操作规则
- 批量操作必须有明确的conditions
- 超过10条记录的批量操作需要二次确认
- 批量删除必须有安全限制
```

### Phase 2: 实现完整的Update操作

**文件**: `apps/api/src/services/mcpExecutor.ts`

新增`updateEntity()`函数：

```typescript
async function updateEntity(
  command: MCPCommand,
  context: ExecutionContext
): Promise<MCPExecutionResult> {
  const { entity, data, conditions } = command;
  
  // 1. 根据conditions查找要更新的记录
  // 2. 验证更新的合法性（如不能更新已支付发票的金额）
  // 3. 处理级联更新（如更新client.name时同步更新session.clientName）
  // 4. 执行更新
  // 5. 返回更新的记录数和详情
}
```

支持的更新场景：

- 单条记录更新（通过ID或unique条件）
- 批量更新（通过conditions匹配多条）
- 级联更新（更新client名称时同步更新相关session）

### Phase 3: 实现完整的Delete操作

**文件**: `apps/api/src/services/mcpExecutor.ts`

新增`deleteEntity()`函数：

```typescript
async function deleteEntity(
  command: MCPCommand,
  context: ExecutionContext
): Promise<MCPExecutionResult> {
  const { entity, conditions, metadata } = command;
  
  // 1. 查找要删除的记录
  // 2. 检查关联依赖（防止孤立数据）
  // 3. 处理级联删除（如果metadata中指定cascadeDelete）
  // 4. 执行删除
  // 5. 返回删除的记录数和详情
}
```

关联删除逻辑：

```typescript
async function cascadeDeleteClient(clientId: string, context: ExecutionContext) {
  // 1. 删除该客户的所有sessions（检查是否在已支付发票中）
  // 2. 删除该客户的所有rates
  // 3. 删除该客户的草稿发票
  // 4. 删除客户记录
}
```

### Phase 4: 扩展所有实体的CRUD支持

**文件**: `apps/api/src/services/mcpExecutor.ts`

当前`createEntity()`中的switch只处理了client、session、rate、sessionType、clientType。

需要添加：

```typescript
case 'invoice':
  // 验证lineItems中的sessionId是否存在且未结算
  // 自动计算subtotal、taxAmount、totalAmount
  // 生成invoiceNumber
  
case 'expense':
  // 验证category存在
  // 处理imageUrl上传
  // 关联clientId（如果提供）
  
case 'expenseCategory':
  // 验证名称唯一性
  // 支持自定义icon
```

同样在`searchEntity()`、`updateEntity()`、`deleteEntity()`中添加对应的case。

### Phase 5: 实现复杂查询组合

**文件**: `apps/api/src/services/mcpExecutor.ts`

增强`searchEntity()`函数：

```typescript
// 支持的查询条件
- 多字段组合查询（AND逻辑）
- 日期范围（dateRange）
- 数值范围（amountMin, amountMax）
- 模糊匹配（nameContains）
- 排序（orderBy, orderDirection）
- 分页（limit, offset）
- 聚合（groupBy, aggregate: sum/count/avg）
- 关联查询（join client和session）
```

新增辅助函数：

```typescript
async function complexSearch(
  commands: MCPCommand[],
  context: ExecutionContext
): Promise<MCPExecutionResult> {
  // 处理多表关联查询
  // 实现aggregation逻辑
}
```

### Phase 6: 增加操作安全保护

**文件**: `apps/api/src/services/mcpExecutor.ts`

```typescript
async function validateOperation(
  command: MCPCommand,
  context: ExecutionContext
): Promise<{ valid: boolean; error?: string }> {
  switch (command.operation) {
    case 'delete':
      // 不能删除已支付发票中的session
      // 不能删除正在使用的sessionType
      // 批量删除限制最多100条
      
    case 'update':
      // 不能修改已支付发票的金额
      // 不能修改已过去的session的日期（可配置）
  }
}
```

### Phase 7: 新增MCP操作类型

**文件**: `packages/shared/src/types/mcp.ts`

```typescript
export type MCPOperation = 
  | 'create' 
  | 'read' 
  | 'update' 
  | 'delete' 
  | 'search'
  | 'merge'        // 新增：合并记录
  | 'batch'        // 新增：批量操作
  | 'aggregate';   // 新增：聚合查询
```

实现merge操作：

```typescript
// "合并Hubery和Hubert这两个客户"
async function mergeEntities(
  sourceId: string,
  targetId: string,
  entity: MCPEntity,
  context: ExecutionContext
) {
  // 1. 将所有sourceId的关联记录指向targetId
  // 2. 合并联系信息、notes等
  // 3. 删除sourceId记录
}
```

### Phase 8: 前端展示增强

**文件**: `apps/web/src/components/AIAssistant.tsx`

```typescript
// 更丰富的结果展示
- Update结果：显示更新前后的对比
- Delete结果：显示删除的记录数量和摘要
- Complex query结果：支持表格、图表展示
- 关联操作结果：显示级联影响的记录
```

### Phase 9: 添加操作历史和撤销

**文件**: 新建`apps/api/src/services/mcpHistory.ts`

```typescript
export async function saveHistory(
  userId: string,
  workflow: MCPWorkflow,
  result: MCPExecutionResult
): Promise<void> {
  // 保存到Firestore的mcpHistory collection
}

export async function undoLastOperation(
  userId: string
): Promise<MCPExecutionResult> {
  // 查询最近的操作
  // 执行反向操作（create->delete, update->restore, delete->restore）
}
```

在AI router中添加：

```typescript
undo: adminProcedure.mutation(async ({ ctx }) => {
  return undoLastOperation(ctx.user.uid);
});
```

## 文件修改清单

### 核心文件

1. `packages/shared/src/types/mcp.ts` - 扩展操作类型
2. `apps/api/src/services/aiService.ts` - 增强AI prompt（200+ lines）
3. `apps/api/src/services/mcpExecutor.ts` - 实现完整CRUD（500+ lines）
4. `apps/api/src/services/mcpHistory.ts` - 新建历史记录服务
5. `apps/api/src/routers/ai.ts` - 添加undo endpoint
6. `apps/web/src/components/AIAssistant.tsx` - 增强结果展示

### 测试文件（建议创建）

1. `apps/api/src/services/__tests__/mcpExecutor.test.ts`
2. `apps/api/src/services/__tests__/aiService.test.ts`

## 预期效果

完成后，用户可以使用自然语言完成：

✅ 所有8种实体的增删改查

✅ 复杂查询（多条件、关联、聚合）

✅ 安全的关联删除

✅ 批量操作

✅ 记录合并

✅ 操作历史和撤销

✅ AI创建标记追踪

**示例对话**：

```
用户："删除所有AI创建的测试数据"
AI：找到15条AI创建的记录（3个clients，8个sessions，4个rates），确认删除吗？
用户：确认
AI：已删除15条记录

用户："查询本月Tom的总课时和收入"
AI：Tom本月共有12节课，总时长24小时，总收入1920元

用户："撤销上一个操作"
AI：已恢复15条被删除的记录
```

## 风险和注意事项

1. **数据安全**：批量删除和关联删除需要多重确认
2. **性能**：复杂查询可能需要Firestore索引
3. **AI理解准确性**：ambiguous命令需要用户明确
4. **操作可逆性**：重要操作记录历史，支持撤销
5. **权限控制**：确保用户只能操作自己的数据

### To-dos

- [ ] 安装Gemini SDK、配置环境变量、更新验证schema
- [ ] 创建aiService.ts，实现Gemini API集成和自然语言解析
- [ ] 定义MCP协议类型（MCPCommand、操作类型、实体类型）
- [ ] 实现mcpExecutor.ts，处理CRUD操作和智能搜索逻辑
- [ ] 创建AI Router（ai.chat、ai.execute、ai.suggest端点）
- [ ] 创建AIAssistant组件，实现对话式UI界面
- [ ] 集成AI助手到Dashboard，创建快捷入口
- [ ] 实现智能逻辑（上下文理解、时间解析、自动补全）
- [ ] 完善错误处理和审计日志
- [ ] 测试各种场景，优化prompt和用户体验