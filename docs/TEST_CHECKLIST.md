# 测试检查清单
# Test Checklist

快速功能测试清单，确保所有核心功能正常工作。

---

## 🏃 快速开始

### 方式 1: 自动化测试

```bash
# 测试本地环境
./scripts/run-tests.sh
# 选择选项 1

# 测试生产环境
./scripts/run-tests.sh
# 选择选项 2，输入您的 API 和前端 URL
```

### 方式 2: 手动测试（跟随本清单）

---

## ✅ 基础设施测试

### 前端 (Vercel)

- [ ] **页面加载**: 访问前端 URL，页面正常加载
- [ ] **样式加载**: CSS 样式正确显示（不是纯文本）
- [ ] **无控制台错误**: 打开浏览器开发者工具，Console 无红色错误
- [ ] **HTTPS**: 地址栏显示🔒图标（生产环境）
- [ ] **响应式设计**: 在手机/平板尺寸下正常显示

**检查方法**:
```bash
# 访问前端
open https://your-app.vercel.app  # macOS
# 或在浏览器中打开 URL

# 按 F12 打开开发者工具，查看 Console
```

### 后端 (Cloud Run)

- [ ] **健康检查**: `/health` 端点返回 `{"status":"ok"}`
- [ ] **响应时间**: 健康检查响应时间 < 1秒
- [ ] **HTTPS**: API URL 使用 https://
- [ ] **CORS**: 允许前端域名访问

**检查方法**:
```bash
API_URL="https://your-api.run.app"

# 健康检查
curl $API_URL/health

# 测试响应时间
time curl $API_URL/health

# 测试 CORS
curl -I -H "Origin: https://your-app.vercel.app" $API_URL/health | grep -i access-control
```

---

## 🔐 认证测试

### Firebase Authentication

- [ ] **登录页面**: 访问应用，未登录时重定向到登录页
- [ ] **Google 登录**: "Sign in with Google" 按钮可点击
- [ ] **登录流程**: 
  1. 点击 Google 登录
  2. 选择账号
  3. 成功登录并重定向到 Dashboard
- [ ] **权限控制**: 只有管理员邮箱可以登录
- [ ] **登出**: 可以成功登出

**检查方法**:
1. 打开隐私/无痕浏览窗口
2. 访问前端 URL
3. 应该看到登录页面
4. 使用您的 Gmail 账号登录
5. 确认能看到 Dashboard

**如果登录失败**:
- 检查 Firebase Console → Authentication → Settings → Authorized domains
- 确认您的 Vercel 域名在列表中
- 检查 `ADMIN_EMAILS` 环境变量包含您的邮箱

---

## 📊 核心功能测试

### 1. Dashboard

访问: `/dashboard`

- [ ] **统计卡片显示**: 
  - Total Clients
  - Sessions (This month)
  - Pending Invoices
  - Knowledge Base Entries
- [ ] **数据加载**: 统计数据正确显示（初次使用应该都是 0）
- [ ] **导航链接**: 点击卡片可以跳转到对应页面
- [ ] **无加载错误**: 页面加载完成，无"加载中"卡住状态

**测试数据**:
```
✅ 正常: 所有卡片显示数字（0 或实际数据）
❌ 错误: 显示"加载中..."不消失，或显示错误信息
```

---

### 2. Client Management（客户管理）

访问: `/dashboard/clients`

#### 2.1 创建客户

- [ ] **打开对话框**: 点击 "Add Client" 按钮
- [ ] **填写表单**:
  - 姓名: `张三`
  - 类型: `Education`
  - 联系方式: `zhangsan@example.com`
  - 手机: `13800138000`
- [ ] **创建成功**: 点击 "Create Client"，对话框关闭
- [ ] **列表显示**: 新客户出现在列表中

#### 2.2 编辑客户

- [ ] **打开编辑**: 点击客户行的编辑按钮（铅笔图标）
- [ ] **修改数据**: 将姓名改为 `张三（已更新）`
- [ ] **保存成功**: 点击 "Save"
- [ ] **更新显示**: 列表中显示更新后的姓名

#### 2.3 筛选客户

- [ ] **类型筛选**: 使用类型下拉菜单筛选
- [ ] **状态筛选**: 使用活跃/非活跃状态筛选
- [ ] **搜索**: 输入姓名搜索（如果已实现）

#### 2.4 停用客户

- [ ] **标记为非活跃**: 编辑客户，取消勾选 "Active"
- [ ] **状态更新**: 客户状态显示为 "Inactive"

**预期结果**:
```
✅ 列表中至少有一个客户（张三）
✅ 客户信息完整显示
✅ 编辑和删除操作正常
```

---

### 3. Rate Management（费率管理）

访问: `/dashboard/rates`

#### 3.1 创建费率

- [ ] **打开对话框**: 点击 "Add Rate"
- [ ] **填写表单**:
  - 客户: 选择刚创建的客户（张三）
  - 服务类型: `Education`
  - 时薪: `200`
  - 币种: `CNY`
  - 生效日期: 今天
- [ ] **创建成功**: 费率出现在列表中

#### 3.2 查看费率历史

- [ ] **历史记录**: 可以看到同一客户的所有费率
- [ ] **当前费率标记**: 最新费率标记为"当前"

#### 3.3 创建多费率

- [ ] **不同服务类型**: 为同一客户创建技术服务费率
  - 服务类型: `Technical`
  - 时薪: `300`
- [ ] **列表显示**: 两个费率都显示

**预期结果**:
```
✅ 至少有 2 个费率记录
✅ 费率正确关联到客户
✅ 不同服务类型分别显示
```

---

### 4. Session Recording（课时记录）

访问: `/dashboard/sessions`

#### 4.1 创建会话

- [ ] **打开对话框**: 点击 "Record Session"
- [ ] **填写基本信息**:
  - 客户: 选择张三
  - 日期: 今天
  - 开始时间: `14:00`
  - 结束时间: `16:00`
  - 服务类型: `Education`

#### 4.2 添加内容块

- [ ] **添加笔记**:
  - 类型: `Text`
  - 内容: `今天我们学习了 React Hooks 的使用，包括 useState 和 useEffect。`
- [ ] **添加更多内容**:
  - 可以添加多个内容块
  - 支持 Markdown 格式（如果已实现）

#### 4.3 自动费率计算

- [ ] **时长计算**: 自动显示 `2.0 小时`
- [ ] **费率显示**: 显示时薪 `¥200/小时`
- [ ] **总金额**: 自动计算 `¥400`

#### 4.4 保存会话

- [ ] **创建成功**: 点击 "Save Session"
- [ ] **列表显示**: 会话出现在列表中
- [ ] **计费状态**: 显示为 "Unbilled"（未开票）

#### 4.5 查看会话详情

- [ ] **打开详情**: 点击会话行
- [ ] **完整信息**: 显示所有内容块、时间、费用

**预期结果**:
```
✅ 至少有 1 个会话记录
✅ 会话正确关联客户和费率
✅ 金额自动计算正确（2小时 × ¥200 = ¥400）
✅ 计费状态为 "unbilled"
```

---

### 5. Invoice Generation（发票生成）

访问: `/dashboard/invoices`

#### 5.1 生成发票

- [ ] **打开对话框**: 点击 "Generate Invoice"
- [ ] **选择客户**: 选择张三
- [ ] **选择会话**: 
  - 应该看到刚才创建的会话（状态: Unbilled）
  - 勾选该会话
- [ ] **添加备注**: `测试发票 - 2024年1月`
- [ ] **生成成功**: 点击 "Generate Invoice"

#### 5.2 查看发票详情

- [ ] **发票编号**: 格式为 `INV-001`（第一张发票）
- [ ] **金额正确**: 
  - 小计: `¥400`
  - 总计: `¥400`（无税）
- [ ] **行项目**: 显示会话明细
- [ ] **状态**: 初始状态为 "Draft"（草稿）

#### 5.3 更新发票状态

- [ ] **标记为已发送**: 
  - 点击 "Update Status"
  - 状态改为 "Sent"
  - 保存
  
- [ ] **标记为已支付**:
  - 再次点击 "Update Status"
  - 状态改为 "Paid"
  - 选择付款日期: 今天
  - 添加付款备注: `已通过支付宝收款`
  - 保存

#### 5.4 检查会话状态联动

- [ ] **返回 Sessions 页面**
- [ ] **会话状态更新**: 原会话状态从 "Unbilled" 变为 "Paid"
- [ ] **关联发票**: 会话关联到发票 `INV-001`

**预期结果**:
```
✅ 成功生成发票 INV-001
✅ 发票金额正确（¥400）
✅ 会话状态自动更新为 "paid"
✅ 会话关联到发票 ID
```

---

### 6. Knowledge Base（知识库）

访问: `/dashboard/knowledge`

#### 6.1 创建普通笔记

- [ ] **打开对话框**: 点击 "Add Entry"
- [ ] **填写信息**:
  - 标题: `项目部署笔记`
  - 类型: `Note`
  - 分类: `Documentation`
  - 标签: `deployment`, `guide`
  - 内容: `## Vercel 部署步骤\n1. 推送代码\n2. 导入项目\n3. 配置环境变量`
  - **不勾选** "Require Encryption"
- [ ] **保存成功**: 条目出现在列表中

#### 6.2 创建加密条目（重要测试）

- [ ] **打开对话框**: 点击 "Add Entry"
- [ ] **填写敏感信息**:
  - 标题: `OpenAI API Key`
  - 类型: `API Key`（自动加密）
  - 分类: `Credentials`
  - 内容: `sk-test-1234567890abcdefghijklmnopqrstuvwxyz`
  - 自动勾选 "Require Encryption"
- [ ] **加密成功**: 创建时后端使用 KMS 加密

#### 6.3 查看加密条目

- [ ] **列表显示**: 在列表中内容显示为 `[ENCRYPTED]`
- [ ] **打开详情**: 点击条目
- [ ] **自动解密**: 内容自动解密并完整显示
- [ ] **访问计数**: 访问次数增加

#### 6.4 搜索和筛选

- [ ] **类型筛选**: 按 "API Key" 筛选
- [ ] **标签筛选**: 按标签筛选
- [ ] **搜索**: 输入标题关键词搜索

**预期结果**:
```
✅ 至少有 2 个知识库条目
✅ 加密条目在列表中显示为 [ENCRYPTED]
✅ 打开加密条目时自动解密
✅ 搜索和筛选功能正常
```

**这是核心安全测试！确保 Google Cloud KMS 正常工作。**

---

### 7. Sharing Links（分享链接）

访问: `/dashboard/sharing`

#### 7.1 创建分享链接

- [ ] **打开对话框**: 点击 "Create Sharing Link"
- [ ] **选择会话**: 选择之前创建的会话
- [ ] **设置过期**: 默认 90 天（可修改为 7 天测试）
- [ ] **生成成功**: 获得分享链接

#### 7.2 测试分享链接（公开访问）

- [ ] **复制链接**: 格式如 `https://your-app.vercel.app/share/xxxxx`
- [ ] **隐私浏览**: 打开新的隐私/无痕窗口
- [ ] **访问链接**: 粘贴分享链接
- [ ] **内容显示**: 
  - ✅ 显示：客户名、日期、时间、内容块
  - ❌ 不显示：财务信息、费率、发票号
- [ ] **访问计数**: 返回管理界面，访问次数 +1

#### 7.3 撤销链接

- [ ] **撤销操作**: 点击 "Revoke"
- [ ] **状态更新**: 状态变为 "Revoked"
- [ ] **再次访问**: 访问链接显示"已撤销"错误

#### 7.4 过期测试（可选）

- [ ] **创建短期链接**: 过期时间 1 分钟
- [ ] **等待过期**: 等待 1 分钟
- [ ] **访问过期链接**: 显示"已过期"错误

**预期结果**:
```
✅ 分享链接可以无需登录访问
✅ 只显示会话内容，不显示财务信息
✅ 撤销后无法访问
✅ 访问计数正确
```

---

### 8. Company Profile（公司资料）

访问: `/dashboard/profile` 或 `/dashboard/settings`

#### 8.1 填写公司信息

- [ ] **公司名称**: `测试教育科技有限公司`
- [ ] **税号**: `91110000MA01XXXXX`
- [ ] **地址**: `北京市海淀区中关村大街1号`
- [ ] **银行信息**:
  - 开户行: `中国工商银行北京分行`
  - 账号: `1234567890123456789`
  - 户名: `测试教育科技有限公司`
- [ ] **联系信息**:
  - 邮箱: `contact@test-edu.com`
  - 电话: `010-12345678`

#### 8.2 保存和显示

- [ ] **保存成功**: 点击 "Save"
- [ ] **刷新页面**: 刷新浏览器
- [ ] **信息保留**: 所有信息仍然显示

**预期结果**:
```
✅ 公司信息正确保存
✅ 刷新后信息仍然存在
✅ 信息可以编辑和更新
```

---

## 📈 数据一致性测试

### Revenue Report（收入报告）

访问: `/dashboard`

- [ ] **总收入**: Dashboard 显示本月总收入（¥400，如果只有一个会话）
- [ ] **计费状态分布**:
  - Unbilled: ¥0（所有会话已开票）
  - Billed: ¥0（已标记为已支付）
  - Paid: ¥400
- [ ] **客户排名**: Top Clients 显示张三，收入 ¥400

### 数据联动检查

创建流程验证：
1. **创建客户** → 客户列表 +1
2. **创建费率** → 费率列表 +1
3. **记录会话** → 会话列表 +1，状态 "unbilled"
4. **生成发票** → 发票列表 +1，会话状态变 "billed"
5. **标记已支付** → 会话状态变 "paid"，收入报告更新

- [ ] **客户计数**: Dashboard 显示 1 个客户
- [ ] **会话计数**: Dashboard 显示本月 1 个会话
- [ ] **发票计数**: Dashboard 显示 0 个待支付发票（因为已支付）
- [ ] **收入一致**: 所有页面显示的收入数据一致

**预期结果**:
```
✅ Dashboard 统计数据与各模块一致
✅ 会话状态随发票状态正确更新
✅ 收入计算准确
```

---

## 🔍 边界条件测试

### 1. 空数据测试

- [ ] **新系统**: 所有列表为空时，显示友好的空状态提示
- [ ] **无搜索结果**: 搜索不存在的内容，显示"未找到结果"

### 2. 数据验证

- [ ] **必填字段**: 尝试不填必填字段提交，显示验证错误
- [ ] **日期验证**: 开始时间晚于结束时间，显示错误
- [ ] **金额验证**: 输入负数或非数字，显示错误

### 3. 权限测试

- [ ] **登出测试**: 登出后访问 `/dashboard`，重定向到登录页
- [ ] **非管理员**: 使用非管理员邮箱登录，应该被拒绝

---

## 🚨 错误处理测试

### 网络错误

- [ ] **断网测试**: 断开网络，尝试操作，显示友好错误提示
- [ ] **API 错误**: 如果 API 宕机，前端显示错误而不是崩溃

### 并发测试

- [ ] **重复提交**: 快速点击提交按钮两次，不应该创建重复数据
- [ ] **同时编辑**: （高级）两个标签页同时编辑同一数据

---

## 📊 测试结果记录

### 测试日期: ___________

### 测试人: ___________

### 测试环境:
- [ ] 本地开发环境
- [ ] 生产环境 (Vercel + Cloud Run)

### 总体评分:

| 模块 | 通过率 | 备注 |
|------|--------|------|
| 基础设施 | ___% | |
| 认证 | ___% | |
| 客户管理 | ___% | |
| 费率管理 | ___% | |
| 会话记录 | ___% | |
| 发票生成 | ___% | |
| 知识库 | ___% | |
| 分享链接 | ___% | |
| 公司资料 | ___% | |
| 数据一致性 | ___% | |

### 发现的问题:

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

### 建议改进:

1. _______________________________________________
2. _______________________________________________
3. _______________________________________________

---

## 🎯 快速冒烟测试（2分钟）

如果时间有限，至少完成这些核心测试：

```
✅ 前端可访问
✅ 后端健康检查通过
✅ 可以登录
✅ Dashboard 加载
✅ 可以创建一个客户
✅ 可以记录一个会话
✅ 可以生成一张发票
✅ 可以创建一个知识库条目（加密）
```

**如果以上 8 项全部通过，系统基本可用！**

---

## 📞 遇到问题？

### 查看日志

**Cloud Run 日志**:
```bash
gcloud run services logs tail student-record-api --region asia-east1
```

**Vercel 日志**:
- Vercel Dashboard → Deployments → 选择部署 → View Logs

### 常见问题

1. **无法登录**: 检查 Firebase Console → Authentication → Authorized domains
2. **API 错误**: 检查 Cloud Run 环境变量和服务账号权限
3. **加密失败**: 检查 KMS 密钥和服务账号权限
4. **CORS 错误**: 检查 Cloud Run 的 `CORS_ORIGIN` 环境变量

### 获取帮助

- 查看 `docs/DEPLOY_AND_TEST.md`
- 查看 `docs/GOOGLE_CLOUD_SETUP.md`
- 检查 GitHub Issues
- 查看 Cloud Run 日志

---

**祝测试顺利！🎉**

